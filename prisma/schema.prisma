// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Producto {
  id                      Int              @id @default(autoincrement())
  nombre                  String
  descripcion             String?
  precio                  Float
  stock                   Int              @default(0)
  imagenUrl               String?          // Mantener por compatibilidad
  imagenes                ProductoImagen[]
  carrito                 CarritoItem[]
  categoria               String           @default("fimu") // fimu, perchero, etc.
  estado                  String           @default("disponible") // disponible, reservado, vendido
  reservadoEn             DateTime?        @map("reservado_en") // Timestamp cuando se dio click en Pagar
  compradorInfo           String?          @map("comprador_info") // Info del comprador (nombre, contacto, etc)
  reservaPausada          Boolean          @default(false) @map("reserva_pausada") // Admin puede pausar el cron贸metro
  pausadoEn               DateTime?        @map("pausado_en") // Timestamp cuando se paus贸
  
  //  NUEVOS CAMPOS: Para identificar qui茅n reserv贸 el producto
  reservadoPorSessionId   String?          @map("reservado_por_session_id") // Session ID de quien reserv贸
  reservadoPorUsuarioId   Int?             @map("reservado_por_usuario_id") // User ID de quien reserv贸
  reservadoPor            Usuario?         @relation("ProductoReservadoPor", fields: [reservadoPorUsuarioId], references: [id], onDelete: SetNull)
  
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  @@index([estado]) // ndice para filtrar por estado
  @@index([createdAt]) // ndice para ordenar por fecha
  @@index([categoria]) // ndice para filtrar por categor铆a
  @@index([reservadoPorSessionId]) // ndice para b煤squedas por sessionId
  @@index([reservadoPorUsuarioId]) // ndice para b煤squedas por usuarioId
  @@map("productos")
}

model ProductoImagen {
  id             Int      @id @default(autoincrement())
  productoId     Int
  url            String
  esPrincipal    Boolean  @default(false)
  orden          Int      @default(0)
  createdAt      DateTime @default(now())
  
  producto       Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@index([productoId]) // ndice para b煤squedas por producto
  @@index([esPrincipal]) // ndice para filtrar imagen principal
  @@map("producto_imagenes")
}

model CarritoItem {
  id             Int      @id @default(autoincrement())
  productoId     Int      @map("producto_id")
  sessionId      String?  @map("session_id") // UUID del navegador/dispositivo para usuarios an贸nimos
  usuarioId      Int?     @map("usuario_id") // ID del usuario logueado (si aplica)
  cantidad       Int      @default(1)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  producto       Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  usuario        Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([productoId]) // ndice para b煤squedas por producto
  @@index([sessionId]) // ndice para b煤squedas por sesi贸n
  @@index([usuarioId]) // ndice para b煤squedas por usuario
  // Restricci贸n 煤nica compuesta: un producto solo puede estar una vez POR SESIN o POR USUARIO
  // Nota: sessionId y usuarioId son mutuamente excluyentes (uno ser谩 null)
  @@map("carrito_items")
}

model Usuario {
  id                  Int            @id @default(autoincrement())
  email               String         @unique
  supabaseId          String?        @unique @map("supabase_id") // UUID de Supabase Auth
  nombre              String?
  apellido            String?
  redSocial           String?        @map("red_social") // 'facebook', 'instagram', 'tiktok', 'otro'
  nombreRedSocial     String?        @map("nombre_red_social") // El @ o nombre de usuario
  whatsapp            String?
  isAdmin             Boolean        @default(false) @map("is_admin")
  carritoItems        CarritoItem[]  // Relaci贸n con items del carrito
  productosReservados Producto[]     @relation("ProductoReservadoPor") // Productos que este usuario reserv贸
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  @@index([email])
  @@index([supabaseId])
  @@index([isAdmin])
  @@map("usuarios")
}

model ConfiguracionCategoria {
  id             Int      @id @default(autoincrement())
  categoria      String   @unique
  visible        Boolean  @default(true)
  nombreMostrar  String   @map("nombre_mostrar")
  icono          String?
  orden          Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([categoria])
  @@index([visible])
  @@map("configuracion_categorias")
}
